<template>
  <div class="available-stalls">
    <!-- Loading State -->
    <div v-if="loading" class="loading-state">
      <p>Loading available stalls...</p>
    </div>

    <!-- Error State -->
    <div v-else-if="error" class="error-state">
      <p>{{ error }}</p>
      <button @click="$emit('retry')" class="retry-btn">Try Again</button>
    </div>

    <!-- Stalls Grid with fade animation -->
    <div v-else>
      <transition name="fade-pagination" mode="out-in">
        <div class="stall-grid" :key="currentPage">
          <div class="stall-card" v-for="stall in paginatedStalls" :key="stall.id" @click="openStallDetails(stall)">
            <div class="stall-image">
              <img :src="stall.imageUrl" :alt="`Stall ${stall.stallNumber}`" @error="handleImageError" />
              <div class="stall-status-badge" :class="getStallBadgeClass(stall)">
                {{ getStallBadgeText(stall) }}
              </div>
            </div>
            <div class="stall-info">
              <div class="stall-header">
                <span class="stall-badge">{{ stall.stallNumber }}</span>
                <span class="stall-price">{{ stall.price }}</span>
              </div>
              <div class="stall-details">
                <p>
                  <strong>{{ stall.floor }}</strong> / {{ stall.section }}
                </p>
                <div class="size-btn-row">
                  <p>{{ stall.dimensions }}</p>
                  <button v-if="shouldShowApplyButton(stall)" class="apply-btn" @click.stop="openApplyForm(stall)">
                    APPLY NOW!
                  </button>
                  <button v-else-if="!stall.isAvailable" class="apply-btn occupied" disabled>
                    OCCUPIED
                  </button>
                  <!-- No button for Auction and Raffle stalls -->
                </div>
                <p class="location-info">
                  <strong>{{ stall.branch }}</strong> - {{ stall.branchLocation }}
                </p>
                <p class="stall-description">{{ stall.description }}</p>
                <div v-if="stall.managerName" class="manager-info">
                  Managed by: {{ stall.managerName }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </transition>
    </div>

    <!-- Pagination Controls -->
    <div v-if="!loading && !error && totalPages > 1" class="pagination-controls">
      <button class="pagination-btn prev-btn" @click="previousPage" :disabled="currentPage === 1"
        :class="{ disabled: currentPage === 1 }">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        Previous
      </button>

      <div class="pagination-info">
        <span>Page {{ currentPage }} of {{ totalPages }}</span>
        <span class="stall-count">({{ filteredStalls.length }} stalls)</span>
      </div>

      <button class="pagination-btn next-btn" @click="nextPage" :disabled="currentPage === totalPages"
        :class="{ disabled: currentPage === totalPages }">
        Next
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>
    </div>

    <!-- No Results Message -->
    <div v-if="!loading && !error && filteredStalls.length === 0" class="no-results">
      <div class="no-results-content">
        <h3>No stalls found</h3>
        <p>No stalls match your current filters. Try adjusting your search criteria.</p>
      </div>
    </div>

    <!-- StallApplicationContainer.vue -->
    <StallApplicationContainer v-if="showApplyForm" :stall="selectedStall" :showForm="showApplyForm"
      @close="closeApplyForm" />

    <!-- Stall Details Modal -->
    <transition name="modal-fade">
      <div v-if="showStallDetails" class="modal-overlay" @click.self="closeStallDetails">
        <div class="modal-container compact">
          <div class="modal-header">
            <h2>Stall Details</h2>
            <button class="close-btn" @click="closeStallDetails">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>
          </div>

          <div class="modal-content" v-if="selectedStallDetails">
            <!-- Image Gallery Section -->
            <div class="modal-image-gallery">
              <div class="gallery-main-image" @click="openFullscreenViewer">
                <img :src="currentDisplayImage" :alt="`Stall ${selectedStallDetails.stallNumber}`"
                  @error="handleImageError" />
                
                <!-- Click to expand hint -->
                <div class="expand-hint">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="3" x2="14" y2="10"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                  </svg>
                </div>
                
                <!-- Image navigation arrows (only show if multiple images) -->
                <template v-if="stallImages.length > 1">
                  <button class="gallery-nav prev" @click.stop="prevImage" :disabled="currentImageIndex === 0">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                  </button>
                  <button class="gallery-nav next" @click.stop="nextImage" :disabled="currentImageIndex === stallImages.length - 1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </button>
                </template>
                
                <!-- Image counter -->
                <div class="image-counter" v-if="stallImages.length > 0">
                  {{ currentImageIndex + 1 }} / {{ stallImages.length }}
                </div>
              </div>
              
              <!-- Thumbnail strip (only show if multiple images) -->
              <div class="gallery-thumbnails" v-if="stallImages.length > 1">
                <div 
                  v-for="(img, index) in stallImages" 
                  :key="img.id || index"
                  class="thumbnail"
                  :class="{ active: currentImageIndex === index }"
                  @click="currentImageIndex = index"
                >
                  <img :src="buildImageUrl(img.image_url)" :alt="`Image ${index + 1}`" @error="handleThumbnailError($event)" />
                </div>
              </div>
            </div>

            <div class="modal-info-section">
              <div class="info-row">
                <span class="info-label">Stall Number:</span>
                <span class="info-value stall-number-highlight">{{ selectedStallDetails.stallNumber }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Price:</span>
                <span class="info-value price-highlight">{{ selectedStallDetails.price }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Price Type:</span>
                <span class="info-value">{{ selectedStallDetails.price_type || 'Fixed Price' }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Floor:</span>
                <span class="info-value">{{ selectedStallDetails.floor }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Section:</span>
                <span class="info-value">{{ selectedStallDetails.section }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Dimensions:</span>
                <span class="info-value">{{ selectedStallDetails.dimensions }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Branch:</span>
                <span class="info-value">{{ selectedStallDetails.branch }}</span>
              </div>

              <div class="info-row">
                <span class="info-label">Location:</span>
                <span class="info-value">{{ selectedStallDetails.branchLocation }}</span>
              </div>

              <div class="info-row" v-if="selectedStallDetails.managerName">
                <span class="info-label">Manager:</span>
                <span class="info-value">{{ selectedStallDetails.managerName }}</span>
              </div>

              <div class="info-row full-width" v-if="selectedStallDetails.description">
                <span class="info-label">Description:</span>
                <p class="info-description">{{ selectedStallDetails.description }}</p>
              </div>

              <div class="modal-actions">
                <button v-if="shouldShowApplyButton(selectedStallDetails)" class="modal-apply-btn"
                  @click="applyFromModal">
                  APPLY NOW!
                </button>
                <button v-else-if="!selectedStallDetails.isAvailable" class="modal-apply-btn occupied" disabled>
                  OCCUPIED
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- Fullscreen Image Viewer -->
    <transition name="fade">
      <div v-if="showFullscreenViewer" class="fullscreen-viewer" @click.self="closeFullscreenViewer">
        <button class="fullscreen-close" @click="closeFullscreenViewer">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6L18 18"></path>
          </svg>
        </button>
        
        <div class="fullscreen-content">
          <!-- Main Image -->
          <div class="fullscreen-image-container">
            <img :src="currentDisplayImage" :alt="`Stall ${selectedStallDetails?.stallNumber}`" @error="handleImageError" />
          </div>
          
          <!-- Navigation Arrows -->
          <template v-if="stallImages.length > 1">
            <button class="fullscreen-nav prev" @click="prevImage" :disabled="currentImageIndex === 0">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button class="fullscreen-nav next" @click="nextImage" :disabled="currentImageIndex === stallImages.length - 1">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </template>
          
          <!-- Image Counter -->
          <div class="fullscreen-counter" v-if="stallImages.length > 0">
            {{ currentImageIndex + 1 }} / {{ stallImages.length }}
          </div>
          
          <!-- Thumbnail Strip -->
          <div class="fullscreen-thumbnails" v-if="stallImages.length > 1">
            <div 
              v-for="(img, index) in stallImages" 
              :key="img.id || index"
              class="fullscreen-thumb"
              :class="{ active: currentImageIndex === index }"
              @click="currentImageIndex = index"
            >
              <img :src="buildImageUrl(img.image_url)" :alt="`Image ${index + 1}`" @error="handleThumbnailError($event)" />
            </div>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<script>
import StallApplicationContainer from '../StallApplicationContainer.vue'
import stallBackgroundImg from '@/assets/stallbackground.png'

export default {
  name: 'AvailableStalls',
  components: {
    StallApplicationContainer,
  },
  props: {
    filteredStalls: {
      type: Array,
      default: () => [],
    },
    loading: {
      type: Boolean,
      default: false,
    },
    error: {
      type: String,
      default: null,
    },
  },
  data() {
    return {
      showApplyForm: false,
      selectedStall: null,
      showStallDetails: false,
      selectedStallDetails: null,
      currentPage: 1,
      stallsPerPage: 8,
      // Image gallery
      stallImages: [],
      currentImageIndex: 0,
      loadingImages: false,
      // Fullscreen viewer
      showFullscreenViewer: false,
    }
  },
  computed: {
    totalPages() {
      return Math.ceil(this.filteredStalls.length / this.stallsPerPage)
    },
    paginatedStalls() {
      const startIndex = (this.currentPage - 1) * this.stallsPerPage
      const endIndex = startIndex + this.stallsPerPage
      const stalls = this.filteredStalls.slice(startIndex, endIndex)

      // Ensure all stalls have an image
      return stalls.map((stall) => ({
        ...stall,
        imageUrl: stall.imageUrl || stall.image || stallBackgroundImg,
      }))
    },
    currentDisplayImage() {
      // If we have fetched images, use the current one
      if (this.stallImages.length > 0 && this.stallImages[this.currentImageIndex]) {
        return this.buildImageUrl(this.stallImages[this.currentImageIndex].image_url)
      }
      // Fallback to the stall's primary image
      return this.selectedStallDetails?.imageUrl || stallBackgroundImg
    },
  },
  watch: {
    filteredStalls() {
      this.currentPage = 1
    },
  },
  methods: {
    handleImageError(event) {
      event.target.src = stallBackgroundImg
    },

    handleThumbnailError(event) {
      event.target.src = stallBackgroundImg
    },

    buildImageUrl(imagePath) {
      if (!imagePath) return stallBackgroundImg
      if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
        return imagePath
      }
      const imageBaseUrl = import.meta.env.VITE_IMAGE_BASE_URL || 'http://localhost'
      return `${imageBaseUrl}${imagePath}`
    },

    async openStallDetails(stall) {
      this.selectedStallDetails = stall
      this.showStallDetails = true
      this.currentImageIndex = 0
      this.stallImages = []
      
      // Fetch all images for this stall
      await this.fetchStallImages(stall.id)
    },

    async fetchStallImages(stallId) {
      if (!stallId) return
      
      this.loadingImages = true
      try {
        const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api'
        const response = await fetch(`${apiUrl}/stalls/${stallId}/images`)
        const data = await response.json()
        
        if (data.success && data.data && data.data.images) {
          this.stallImages = data.data.images
          console.log(`ðŸ“· Loaded ${this.stallImages.length} images for stall ${stallId}`)
        }
      } catch (error) {
        console.error('âŒ Failed to fetch stall images:', error)
      } finally {
        this.loadingImages = false
      }
    },

    prevImage() {
      if (this.currentImageIndex > 0) {
        this.currentImageIndex--
      }
    },

    nextImage() {
      if (this.currentImageIndex < this.stallImages.length - 1) {
        this.currentImageIndex++
      }
    },

    closeStallDetails() {
      this.showStallDetails = false
      this.selectedStallDetails = null
      this.stallImages = []
      this.currentImageIndex = 0
      this.showFullscreenViewer = false
    },

    openFullscreenViewer() {
      this.showFullscreenViewer = true
      // Prevent body scroll when fullscreen is open
      document.body.style.overflow = 'hidden'
    },

    closeFullscreenViewer() {
      this.showFullscreenViewer = false
      // Restore body scroll
      document.body.style.overflow = ''
    },

    openImageGallery() {
      // Legacy method - now using fullscreen viewer
      this.openFullscreenViewer()
    },

    applyFromModal() {
      // Close the details modal and open the application form
      this.selectedStall = this.selectedStallDetails
      this.showStallDetails = false
      this.showApplyForm = true
    },

    openApplyForm(stall) {
      console.log('ðŸ“ Opening application form for stall:', {
        stallNumber: stall.stallNumber,
        branch: stall.branch,
        price: stall.price,
        price_type: stall.price_type
      })
      this.selectedStall = stall
      this.showApplyForm = true
    },

    closeApplyForm() {
      this.showApplyForm = false
      this.selectedStall = null
    },

    nextPage() {
      if (this.currentPage < this.totalPages) {
        this.currentPage++
      }
    },

    previousPage() {
      if (this.currentPage > 1) {
        this.currentPage--
      }
    },

    getStallBadgeClass(stall) {
      // If stall is not available (occupied), return unavailable class
      if (!stall.isAvailable) {
        return 'unavailable'
      }

      // For available stalls, return class based on price type
      switch (stall.price_type) {
        case 'Fixed Price':
          return 'available'
        case 'Auction':
          return 'auction'
        case 'Raffle':
          return 'raffle'
        default:
          return 'available' // fallback to available for unknown types
      }
    },

    getStallBadgeText(stall) {
      // If stall is not available (occupied), return "Occupied"
      if (!stall.isAvailable) {
        return 'Occupied'
      }

      // For available stalls, return text based on price type
      switch (stall.price_type) {
        case 'Fixed Price':
          return 'Available'
        case 'Auction':
          return 'Auction'
        case 'Raffle':
          return 'Raffle'
        default:
          return 'Available' // fallback to available for unknown types
      }
    },

    shouldShowApplyButton(stall) {
      // Check if stall is available
      const isAvailable =
        stall.isAvailable === true || stall.isAvailable === 1 || stall.isAvailable === '1'
      if (!isAvailable) {
        return false
      }

      // Get price type and normalize it - default to 'Fixed Price' if empty/null
      const priceType = stall.price_type ? stall.price_type.toString().toLowerCase().trim() : 'fixed price'

      // Only show apply button for Fixed Price stalls
      // Explicitly exclude Auction and Raffle
      const isFixedPrice =
        priceType === 'fixed price' ||
        priceType === 'fixed' ||
        priceType === ''

      // Make sure it's NOT auction or raffle
      const isAuctionOrRaffle = priceType === 'auction' || priceType === 'raffle'

      return isFixedPrice && !isAuctionOrRaffle
    },
  },
}
</script>

<style scoped src="../../../../../assets/css/availablestallstyle.css"></style>
